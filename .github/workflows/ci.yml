# ============================================
# ğŸš€ GitHub Actions CI/CD Pipeline
# ============================================
# Runs tests, backtests, and validates strategy

name: Trading Bot CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  # Manual trigger
  workflow_dispatch:
    inputs:
      run_extended_backtest:
        description: 'Run extended backtest (longer)'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ----------------------------------------
  # ğŸ§ª Unit Tests
  # ----------------------------------------
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirement.txt
          pip install pytest pytest-cov

      - name: ğŸ§ª Run tests
        run: |
          python -m pytest tests/ -v --cov=bot_trade --cov-report=xml

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # ----------------------------------------
  # ğŸ“ˆ Backtest Validation
  # ----------------------------------------
  backtest:
    name: Backtest Strategy
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirement.txt

      - name: ğŸƒ Run backtest
        run: |
          mkdir -p outputs
          python main.py \
            --dataset data/asset_b_train.csv \
            --out outputs/ci_backtest.csv \
            --transaction-fees 0.0001 \
            --slippage 0.0

      - name: ğŸ“Š Calculate scores
        id: score
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from scoring.scoring import score

          result = score('data/asset_b_train.csv', 'outputs/ci_backtest.csv', 0.0001, 0.0)

          print('='*50)
          print('ğŸ“Š BACKTEST RESULTS')
          print('='*50)
          for k, v in result.items():
              print(f'{k}: {v:.4f}')
          print()

          # Set outputs for badge/summary
          base = result.get('base_score', 0)
          sharpe = result.get('sharpe_score', 0)
          pnl = result.get('pnl_score', 0)

          # Write to GitHub output
          with open('$GITHUB_OUTPUT', 'a') as f:
              f.write(f'base_score={base:.4f}\n')
              f.write(f'sharpe_score={sharpe:.4f}\n')
              f.write(f'pnl_score={pnl:.4f}\n')

          # Fail if base_score is negative (strategy underperforms)
          if base < 0:
              print('âŒ Strategy underperforms baseline!')
              sys.exit(1)
          else:
              print('âœ… Strategy passes validation!')
          "

      - name: ğŸ“ Job Summary
        run: |
          echo "## ğŸ“Š Backtest Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Score |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Base Score | ${{ steps.score.outputs.base_score }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sharpe Score | ${{ steps.score.outputs.sharpe_score }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PnL Score | ${{ steps.score.outputs.pnl_score }} |" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload results
        uses: actions/upload-artifact@v4
        with:
          name: backtest-results
          path: outputs/ci_backtest.csv
          retention-days: 30

  # ----------------------------------------
  # ğŸ³ Docker Build
  # ----------------------------------------
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: production
          push: false
          tags: trading-bot:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ§ª Test Docker image
        run: |
          docker run --rm trading-bot:latest python -c "from bot_trade import make_decision; print('âœ… Docker OK')"

  # ----------------------------------------
  # ğŸ” Code Quality
  # ----------------------------------------
  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install linters
        run: |
          pip install ruff

      - name: ğŸ” Run Ruff
        run: |
          ruff check bot_trade.py main.py scoring/ --ignore E501,E402
        continue-on-error: true  # Don't fail CI on style issues

  # ----------------------------------------
  # ğŸ“¡ Live API Check (optional)
  # ----------------------------------------
  api-check:
    name: API Connectivity
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install requests
        run: pip install requests

      - name: ğŸ“¡ Check Binance API
        run: |
          python -c "
          import requests
          r = requests.get('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT', timeout=10)
          r.raise_for_status()
          price = float(r.json()['price'])
          print(f'âœ… Binance API OK - BTC: \${price:,.2f}')
          "

      - name: ğŸ“¡ Check Kraken API
        run: |
          python -c "
          import requests
          r = requests.get('https://api.kraken.com/0/public/Ticker?pair=XBTUSD', timeout=10)
          r.raise_for_status()
          data = r.json()
          price = float(data['result']['XXBTZUSD']['c'][0])
          print(f'âœ… Kraken API OK - BTC: \${price:,.2f}')
          "
